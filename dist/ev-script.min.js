/**
 * ev-script 0.1.0 2013-01-24
 * Ensemble Video Integration Library
 * https://github.com/jmpease/ev-script
 * Copyright (c) 2013 Symphony Video, Inc.
 * Licensed MIT, GPL-2.0
 */

/**
 * almond 0.2.3 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

(function(e,t){typeof define=="function"&&define.amd?define(["jquery","underscore","backbone"],t):e.EV=t(e.$,e._,e.Backbone)})(this,function(e,t,n){var r,i,s;return function(e){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(t,r){return function(){return n.apply(e,p.call(arguments,0).concat([t,r]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(n){if(d(f,n)){var r=f[n];delete f[n],c[n]=!0,t.apply(e,r)}if(!d(a,n)&&!d(c,n))throw new Error("No "+n);return a[n]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var t,n,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},t=function(t,n,r,i){var s,l,h,p,v,g=[],w;i=i||t;if(typeof r=="function"){n=!n.length&&r.length?["require","exports","module"]:n;for(v=0;v<n.length;v+=1){p=o(n[v],i),l=p.f;if(l==="require")g[v]=u.require(t);else if(l==="exports")g[v]=u.exports(t),w=!0;else if(l==="module")s=g[v]=u.module(t);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(t+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=r.apply(a[t],g);if(t)if(s&&s.exports!==e&&s.exports!==a[t])a[t]=s.exports;else if(h!==e||!w)a[t]=h}else t&&(a[t]=r)},r=i=n=function(r,i,s,a,f){return typeof r=="string"?u[r]?u[r](i):b(o(r,i).f):(r.splice||(l=r,i.splice?(r=i,i=s,s=null):r=e),i=i||function(){},typeof s=="function"&&(s=a,a=f),a?t(e,r,i,s):setTimeout(function(){t(e,r,i,s)},15),n)},n.config=function(e){return l=e,n},s=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},s.amd={jQuery:!0}}(),s("almond",function(){}),s("ev-script/models/video-settings",["backbone"],function(e){return e.Model.extend({defaults:{type:"video",showtitle:!1,autoplay:!1,showcaptions:!1,hidecontrols:!1,search:"",sourceId:"content"}})}),s("ev-script/models/playlist-settings",["backbone"],function(e){return e.Model.extend({defaults:{type:"playlist"}})}),s("ev-script/views/hider",["require","underscore","backbone"],function(e){var t=e("underscore"),n=e("backbone");return n.View.extend({initialize:function(e){t.bindAll(this,"hideHandler","logoutHandler","render"),this.picker=e.picker,this.eventAggr=e.eventAggr,this.auth=e.auth,this.eventAggr.bind("authSet",this.render),this.eventAggr.bind("authRemoved",this.render)},events:{"click a.action-hide":"hideHandler","click a.action-logout":"logoutHandler"},render:function(){var e='<a class="action-hide" href="#" title="Hide Picker">Hide</a>'+(this.auth.hasAuth()?'<a class="action-logout" href="#" title="Logout">Logout</a>':"");this.$el.html(e)},hideHandler:function(e){this.picker.hidePicker(),e.preventDefault()},logoutHandler:function(e){this.auth.removeAuth(),e.preventDefault()}})}),s("ev-script/views/picker",["require","jquery","underscore","backbone","ev-script/views/hider"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone"),i=e("ev-script/views/hider");return r.View.extend({initialize:function(e){n.bindAll(this,"chooseItem","hidePicker","showPicker","hideHandler"),e.eventAggr.bind("hidePickers",this.hideHandler),this.$el.hide(),this.auth=e.auth,this.cache=e.cache,this.config=e.config,this.field=e.field,this.hider=new i({id:this.id+"-hider",tagName:"div",className:"ev-hider",picker:this,eventAggr:e.eventAggr,auth:e.auth}),this.$el.append(this.hider.$el),this.hider.render()},events:{"click a.action-add":"chooseItem"},chooseItem:function(e){var n=t(e.target).attr("rel"),r=this.resultsView.collection.get(n);this.model.set({id:n,content:r.toJSON()}),this.field.model.set(this.model.attributes),this.hidePicker(),e.preventDefault()},hidePicker:function(){this.$el.fadeOut("fast")},showPicker:function(){this.hider.render(),this.$el.fadeIn("fast")},hideHandler:function(e){(!e||this!==e)&&this.hidePicker()}})}),s("ev-script/views/search",["require","underscore","backbone"],function(e){var t=e("underscore"),n=e("backbone");return n.View.extend({initialize:function(e){t.bindAll(this,"searchHandler","doSearch","autoSearch"),this.picker=e.picker},events:{"click input.form-submit":"searchHandler","change select.source":"searchHandler","keyup input.form-text":"autoSearch"},render:function(){var e=this.id+"-input",n='<label for="'+e+'">Search Ensemble:</label>'+'<input id="'+e+'" type="text" class="form-text" value="'+this.picker.model.get("search")+'" />'+'<select class="form-select source">'+'  <option value="content" '+(this.picker.model.get("sourceId")==="content"?'selected="selected"':"")+">Media Library</option>"+'  <option value="shared" '+(this.picker.model.get("sourceId")==="shared"?'selected="selected"':"")+">Shared Library</option>"+"</select>"+'<input type="button" value="Go" class="form-submit" />'+'<div class="loader"></div>'+'<div class="ev-poweredby"><a tabindex="-1" target="_blank" href="http://ensemblevideo.com"><span>Powered by Ensemble</span></a></div>';this.$el.html(n);var r=this.$("div.loader");r.bind("ajaxSend",t.bind(function(e,t,n){this.picker===n.picker&&r.addClass("loading")},this)).bind("ajaxComplete",t.bind(function(e,t,n){this.picker===n.picker&&r.removeClass("loading")},this))},doSearch:function(){this.picker.model.set({search:this.$("input.form-text").val(),sourceId:this.$("select.source").val()}),this.picker.loadVideos()},searchHandler:function(e){this.doSearch(),e.preventDefault()},autoSearch:function(e){var n=e.target.value;n!==this.lastValue&&(this.lastValue=n,this.submitTimeout&&clearTimeout(this.submitTimeout),this.submitTimeout=setTimeout(t.bind(function(){this.doSearch()},this),1e3))}})}),s("ev-script/views/results",["require","jquery","underscore","backbone"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone");return r.View.extend({initialize:function(e){n.bindAll(this,"render","loadMore","addHandler","previewItem"),this.picker=e.picker,this.$results=t('<div class="results"/>'),this.$el.append(this.$results),this.auth=e.auth,this.config=e.config},events:{"click a.action-preview":"previewItem"},previewItem:function(e){var n=e.currentTarget,r=t(n).attr("rel"),i=this.collection.get(r),s={id:r,content:i.toJSON()},o=new this.previewClass({el:n,model:new this.modelClass(s),config:this.config});e.stopPropagation(),e.preventDefault()},loadMore:function(){this.collection.hasMore&&this.collection.fetch({async:!1,add:!0,picker:this.picker,success:n.bind(function(e,t,r){n.size(t.Data)<e.pageSize?(e.hasMore=!1,this.$scrollLoader.evScrollLoader("hideLoader")):(e.hasMore=!0,e.pageIndex+=1)},this),error:n.bind(function(e,t,r){this.auth.ajaxError(t,n.bind(function(){this.loadMore()},this))},this)})},addHandler:function(e,t,n){var r=this.getRowHtml(e,n.index);this.$("table.content-list > tbody").append(r)}})}),s("ev-script/views/preview",["require","jquery","underscore","backbone","ev-script/models/video-settings"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone"),i=e("ev-script/models/video-settings");return r.View.extend({initialize:function(e){var r=t('<div class="dialogWrap"></div>');this.$el.after(r);var s=this.model.get("content"),o=this.model.get("width");o=o?o:this.model instanceof i?"640":"800";var u=this.model.get("height");u=u?u:this.model instanceof i?"360":"850",r.dialog({title:s.Title||s.Name,modal:!0,width:parseInt(o,10)+50,height:parseInt(u,10)+140,draggable:!1,resizable:!1,dialogClass:"ev-dialog",create:n.bind(function(t,n){var i=new this.embedClass({model:this.model,config:e.config});r.html(i.$el)},this),close:function(e,t){r.dialog("destroy").remove()}})}})}),s("ev-script/views/video-embed",["require","backbone"],function(e){var t=e("backbone");return t.View.extend({initialize:function(e){var t=this.model.get("width")?this.model.get("width"):"640",n=this.model.get("height")?this.model.get("height"):"360",r='<iframe src="'+e.config.ensembleUrl+"/app/plugin/embed.aspx?ID="+this.model.get("id")+"&autoPlay="+this.model.get("autoplay")+"&displayTitle="+this.model.get("showtitle")+"&hideControls="+this.model.get("hidecontrols")+"&showCaptions="+this.model.get("showcaptions")+"&width="+t+"&height="+n+'" frameborder="0" style="width:'+t+"px;height:"+(parseInt(n,10)+56)+'px;" allowfullscreen></iframe>';this.$el.html(r)}})}),s("ev-script/models/video-encoding",["require","backbone"],function(e){var t=e("backbone");return t.Model.extend({idAttribute:"videoID",initialize:function(e,t){this.config=t.config},url:function(){return this.config.ensembleUrl+"/app/api/content/show.json/"+this.get("fetchId")},getDims:function(){var e=this.get("dimensions").split("x"),t=[];return t[0]=parseInt(e[0],10),t[1]=parseInt(e[1],10),t},getRatio:function(){var e=this.getDims();return e[0]/e[1]},getWidth:function(){return this.getDims()[0]},getHeight:function(){return this.getDims()[1]},parse:function(e){return e.dataSet.encodings}})}),s("ev-script/views/video-preview",["require","underscore","ev-script/views/preview","ev-script/views/video-embed","ev-script/models/video-encoding"],function(e){var t=e("underscore"),n=e("ev-script/views/preview"),r=e("ev-script/views/video-embed"),i=e("ev-script/models/video-encoding");return n.extend({embedClass:r,initialize:function(e){this.encoding=e.encoding||new i({fetchId:this.model.id},{config:e.config});var r=t.bind(function(){(!this.model.get("width")||!this.model.get("height"))&&this.model.set({width:this.encoding.getWidth(),height:this.encoding.getHeight()}),n.prototype.initialize.call(this,e)},this);this.encoding.isNew()?this.encoding.fetch({dataType:"jsonp",success:r}):r()}})}),s("ev-script/views/video-results",["require","jquery","underscore","backbone","ev-script/views/results","ev-script/models/video-settings","ev-script/views/video-preview"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone"),i=e("ev-script/views/results"),s=e("ev-script/models/video-settings"),o=e("ev-script/views/video-preview");return i.extend({modelClass:s,previewClass:o,initialize:function(e){i.prototype.initialize.call(this,e)},getRowHtml:function(e,n){var r=t('<tr class="'+(n%2?"odd":"even")+'"/>'),i='<table class="content-item">  <tbody>    <tr class="title">      <td colspan="2">        <a class="action-preview" title="Preview: '+e.get("Title")+'" href="#" rel="'+e.get("ID")+'">'+e.get("Title")+"</a>"+"      </td>"+"    </tr>"+'    <tr class="desc"><td class="label">Description</td><td class="value">'+e.get("Description")+"</td></tr>"+'    <tr><td class="label">Date Added</td><td class="value">'+(new Date(e.get("AddedOn"))).toLocaleString()+"</td></tr>"+'    <tr><td class="label">Keywords</td><td class="value">'+e.get("Keywords")+"</td></tr>"+'    <tr><td class="label">Library</td><td class="value">'+e.get("LibraryName")+"</td></tr>"+"  </tbody>"+"</table>",s='    <td class="content-actions">      <img src="'+e.get("ThumbnailUrl").replace(/width=100/,"width=150")+'" alt="'+e.get("Title")+' thumbnail image"/>'+'      <div class="action-links">'+'        <a class="action-add" href="#" title="Choose '+e.get("Title")+'" rel="'+e.get("ID")+'"><span>Choose</span></a>'+'        <a class="action-preview" href="#" title="Preview: '+e.get("Title")+'" rel="'+e.get("ID")+'"><span>Preview: '+e.get("Title")+"</span></a>"+"      </div>"+"    </td>"+'    <td class="content-meta">'+i+"</td>";return r.html(s),t("tr.desc td.value",r).each(function(e){var n=t(this),r,i,s=100,o=t(this).html();if(o.length>s){n.empty(),r=t("<span>"+o+"</span>"),i=t("<span>"+o.substring(0,s)+"...</span>");var u=t('<a href="#">Less</a>').click(function(e){r.hide(),i.show(),e.preventDefault()}),a=t('<a href="#">More</a>').click(function(e){i.hide(),r.show(),e.preventDefault()});r.hide().append(u),i.append(a),n.append(i).append(r)}}),r},render:function(){var e=t('<table class="content-list"/>'),n=t("<tbody/>").appendTo(e);this.collection.size()>0?this.collection.each(function(e,t){n.append(this.getRowHtml(e,t))},this):n.append('<tr class="odd"><td colspan="2">No results available.</td></tr>'),this.$results.html(e),this.$results.prepend('<div class="total">Search returned '+this.collection.totalResults+" results.</div>");if(this.collection.size()>=this.config.pageSize||e[0].scrollHeight>600)this.$scrollLoader=e.evScrollLoader({height:600,callback:this.loadMore});this.collection.bind("add",this.addHandler)}})}),s("ev-script/collections/base",["require","backbone"],function(e){var t=e("backbone");return t.Collection.extend({initialize:function(e,t){this.config=t.config},model:t.Model.extend({idAttribute:"ID"}),parse:function(e){return e.Data}})}),s("ev-script/collections/videos",["require","ev-script/collections/base"],function(e){var t=e("ev-script/collections/base");return t.extend({initialize:function(e,t){this.filterOn=t.filterOn,this.filterValue=t.filterValue,this.sourceUrl=t.sourceUrl,this.pageIndex=1,this.hasMore=!0,this.config=t.config},url:function(){var e=this.config.ensembleUrl+this.sourceUrl,t="PageSize="+this.config.pageSize,n="PageIndex="+this.pageIndex,r="FilterOn="+encodeURIComponent(this.filterOn),i="FilterValue="+encodeURIComponent(this.filterValue),s=e+"?"+t+"&"+n+"&"+r+"&"+i;return this.config.urlCallback(s)}})}),s("ev-script/views/video-picker",["require","jquery","underscore","backbone","ev-script/views/picker","ev-script/views/search","ev-script/views/video-results","ev-script/collections/videos"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone"),i=e("ev-script/views/picker"),s=e("ev-script/views/search"),o=e("ev-script/views/video-results"),u=e("ev-script/collections/videos");return i.extend({initialize:function(e){i.prototype.initialize.call(this,e),n.bindAll(this,"loadVideos"),this.searchView=new s({id:this.id+"-search",tagName:"div",className:"ev-search",picker:this}),this.$el.append(this.searchView.$el),this.searchView.render(),this.resultsView=new o({id:this.id+"-results",tagName:"div",className:"ev-results clearfix",picker:this,auth:this.auth,config:this.config}),this.$el.append(this.resultsView.$el)},showPicker:function(){i.prototype.showPicker.call(this),this.searchView.$('input[type="text"]').focus(),this.loadVideos()},loadVideos:function(){var e=t.trim(this.model.get("search").toLowerCase()),r=this.model.get("sourceId"),i=r==="content"?"/api/Content":"/api/SharedContent",s=this.cache.videosCache[this.auth.getUser()+r+e];s?(this.resultsView.collection=s,this.resultsView.render()):(s=new u({},{sourceUrl:i,filterOn:"",filterValue:e,config:this.config}),s.fetch({picker:this,success:n.bind(function(t,i,s){var o=t.totalResults=parseInt(i.Pager.TotalRecords,10),u=n.size(i.Data);u===o?t.hasMore=!1:(t.hasMore=!0,t.pageIndex+=1),this.cache.videosCache[this.auth.getUser()+r+e]=t,this.resultsView.collection=t,this.resultsView.render()},this),error:n.bind(function(e,t,r){this.auth.ajaxError(t,n.bind(function(){this.loadVideos()},this))},this)}))}})}),s("ev-script/views/settings",["require","underscore","backbone"],function(e){var t=e("underscore"),n=e("backbone");return n.View.extend({initialize:function(e){t.bindAll(this,"show","cancelHandler","submitHandler"),this.field=e.field},events:{submit:"submitHandler","click input.action-cancel":"cancelHandler"},show:function(){this.render(),this.$el.dialog("open")},cancelHandler:function(e){this.$el.dialog("close"),e.preventDefault()},submitHandler:function(e){this.updateModel(),this.$el.dialog("close"),e.preventDefault()},updateModel:function(){}})}),s("ev-script/views/video-settings",["require","underscore","ev-script/views/settings"],function(e){var t=e("underscore"),n=e("ev-script/views/settings");return n.extend({initialize:function(e){n.prototype.initialize.call(this,e),this.encoding=e.encoding,this.encoding.bind("change:id",t.bind(function(){this.render()},this))},updateModel:function(){var e={showtitle:this.$("#showtitle").is(":checked"),autoplay:this.$("#autoplay").is(":checked"),showcaptions:this.$("#showcaptions").is(":checked"),hidecontrols:this.$("#hidecontrols").is(":checked")},n=this.$("#size").val();if(n==="original")this.encoding&&!this.encoding.isNew()&&t.extend(e,{width:this.encoding.getWidth(),height:this.encoding.getHeight()});else{var r=n.split("x");t.extend(e,{width:parseInt(r[0],10),height:parseInt(r[1],10)})}this.field.model.set(e)},getSizeSelect:function(){var e=this.field.model.get("width"),n=this.field.model.get("height"),r=16/9,i=["1280x720","1024x576","848x480","720x405","640x360","610x344","560x315","480x270","400x225","320x180","240x135","160x90"];e&&n?r=e/n:this.encoding.id&&(e=this.encoding.getWidth(),n=this.encoding.getHeight(),r=this.encoding.getRatio()),Math.ceil(r*10)/10===Math.ceil(4/3*10)/10&&(i=["1280x960","1024x770","848x636","720x540","640x480","610x460","560x420","480x360","400x300","320x240","240x180","160x120"]);var s=e+"x"+n,o='<select class="form-select" id="size" name="size"><option value="original">Original</option>';return t.each(i,function(e){o+='<option value="'+e+'"'+(e===s?' selected="selected"':"")+">"+e+"</option>"}),o+="</select>",o},render:function(){var e='<form>  <fieldset>    <div class="fieldWrap">      <label for="size">Size</label>'+this.getSizeSelect()+"    </div>"+'    <div class="fieldWrap">'+'      <label for="showtitle">Show Title</label>'+'      <input id="showtitle" class="form-checkbox" '+(this.field.model.get("showtitle")?'checked="checked"':"")+' name="showtitle" type="checkbox"/>'+"    </div>"+'    <div class="fieldWrap">'+'      <label for="autoplay">Auto Play</label>'+'      <input id="autoplay" class="form-checkbox" '+(this.field.model.get("autoplay")?'checked="checked"':"")+' name="autoplay" type="checkbox"/>'+"    </div>"+'    <div class="fieldWrap">'+'      <label for="showcaptions">Show Captions</label>'+'      <input id="showcaptions" class="form-checkbox" '+(this.field.model.get("showcaptions")?'checked="checked"':"")+' name="showcaptions" type="checkbox"/>'+"    </div>"+'    <div class="fieldWrap">'+'      <label for="hidecontrols">Hide Controls</label>'+'      <input id="hidecontrols" class="form-checkbox" '+(this.field.model.get("hidecontrols")?'checked="checked"':"")+' name="hidecontrols" type="checkbox"/>'+"    </div>"+'    <div class="form-actions">'+'      <input type="button" class="form-submit action-cancel" value="Cancel"/>'+'      <input type="submit" class="form-submit action-submit" value="Submit"/>'+"    </div>"+"  </fieldset>"+"</form>";this.$el.html(e).dialog({title:this.field.model.get("content").Title,modal:!0,autoOpen:!1,draggable:!1,resizable:!1,dialogClass:"ev-dialog",width:340,height:320})}})}),s("ev-script/views/organization-select",["require","underscore","backbone"],function(e){var t=e("underscore"),n=e("backbone");return n.View.extend({initialize:function(e){t.bindAll(this,"render"),this.picker=e.picker,this.$el.html('<option value="-1">Loading...</option>'),this.collection.bind("reset",this.render)},render:function(){this.$el.html(""),this.collection.each(function(e){var t=this.picker.model.get("organizationId")===e.id?'selected="selected"':"";this.$el.append('<option value="'+e.id+'" '+t+">"+e.get("Name")+"</option>")},this),this.collection.size()===1?this.$el.hide():this.$el.show(),this.$el.trigger("change")}})}),s("ev-script/collections/organizations",["require","ev-script/collections/base"],function(e){var t=e("ev-script/collections/base");return t.extend({initialize:function(e,n){t.prototype.initialize.call(this,e,n)},url:function(){var e=this.config.ensembleUrl+"/api/Organizations",t="PageSize=9999",n="PageIndex=1",r=e+"?"+t+"&"+n;return this.config.urlCallback(r)}})}),s("ev-script/views/library-select",["require","underscore","backbone"],function(e){var t=e("underscore"),n=e("backbone");return n.View.extend({initialize:function(e){t.bindAll(this,"render"),this.picker=e.picker,this.$el.html('<option value="-1">Loading...</option>'),this.collection.bind("reset",this.render)},render:function(){this.$el.html(""),this.collection.each(function(e){var t=this.picker.model.get("libraryId")===e.id?'selected="selected"':"";this.$el.append('<option value="'+e.id+'" '+t+">"+e.get("Name")+"</option>")},this),this.$el.trigger("change")}})}),s("ev-script/collections/libraries",["require","ev-script/collections/base"],function(e){var t=e("ev-script/collections/base");return t.extend({initialize:function(e,n){t.prototype.initialize.call(this,e,n),this.filterValue=n.organizationId},url:function(){var e=this.config.ensembleUrl+"/api/Libraries",t="PageSize=9999",n="PageIndex=1",r="FilterOn=OrganizationId",i="FilterValue="+encodeURIComponent(this.filterValue),s=e+"?"+t+"&"+n+"&"+r+"&"+i;return this.config.urlCallback(s)}})}),s("ev-script/views/playlist-select",["require","jquery","underscore","backbone","ev-script/views/organization-select","ev-script/collections/organizations","ev-script/views/library-select","ev-script/collections/libraries"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone"),i=e("ev-script/views/organization-select"),s=e("ev-script/collections/organizations"),o=e("ev-script/views/library-select"),u=e("ev-script/collections/libraries");return r.View.extend({initialize:function(e){n.bindAll(this,"loadOrgs","loadLibraries","changeOrganization","changeLibrary","handleSubmit"),this.picker=e.picker,this.id=e.id,this.cache=e.cache,this.config=e.config,this.auth=e.auth;var t=this.id+"-org-select";this.$el.append('<label for="'+t+'">Organization:</label>'),this.orgSelect=new i({id:t,tagName:"select",className:"form-select organizations",picker:this.picker,collection:new s({},{config:this.config})}),this.$el.append(this.orgSelect.$el);var r=this.id+"-lib-select";this.$el.append('<label for="'+r+'">Library:</label>'),this.libSelect=new o({id:r,tagName:"select",className:"form-select libraries",picker:this.picker,collection:new u({},{config:this.config})}),this.$el.append(this.libSelect.$el);var a='<input type="button" value="Go" class="form-submit" /><div class="loader"></div><div class="ev-poweredby"><a tabindex="-1" target="_blank" href="http://ensemblevideo.com"><span>Powered by Ensemble</span></a></div>';this.$el.append(a);var f=this.$("div.loader");f.bind("ajaxSend",n.bind(function(e,t,n){this.picker===n.picker&&f.addClass("loading")},this)).bind("ajaxComplete",n.bind(function(e,t,n){this.picker===n.picker&&f.removeClass("loading")},this))},events:{"change select.organizations":"changeOrganization","change select.libraries":"changeLibrary","click input.form-submit":"handleSubmit"},changeOrganization:function(e){this.picker.model.set({organizationId:e.target.value}),this.loadLibraries()},changeLibrary:function(e){this.picker.model.set({libraryId:e.target.value}),this.picker.loadPlaylists()},handleSubmit:function(e){this.picker.loadPlaylists(),e.preventDefault()},loadOrgs:function(){var e=this.cache.orgsCache[this.auth.getUser()];e?this.orgSelect.collection.reset(e.models):(e=new s({},{config:this.config}),e.fetch({picker:this.picker,success:n.bind(function(e,t,n){this.cache.orgsCache[this.auth.getUser()]=e,this.orgSelect.collection.reset(e.models)},this),error:n.bind(function(e,t,r){this.auth.ajaxError(t,n.bind(function(){this.loadOrgs()},this))},this)}))},loadLibraries:function(){var e=this.picker.model.get("organizationId"),t=this.cache.libsCache[this.auth.getUser()+e];t?this.libSelect.collection.reset(t.models):(t=new u({},{organizationId:e,config:this.config}),t.fetch({picker:this.picker,success:n.bind(function(t,n,r){this.cache.libsCache[this.auth.getUser()+e]=t,this.libSelect.collection.reset(t.models)},this),error:n.bind(function(e,t,r){this.auth.ajaxError(t,n.bind(function(){this.loadLibraries()},this))},this)}))}})}),s("ev-script/views/playlist-embed",["require","backbone"],function(e){var t=e("backbone");return t.View.extend({initialize:function(e){var t='<iframe src="'+e.config.ensembleUrl+"/app/plugin/embed.aspx?DestinationID="+this.model.get("id")+'" frameborder="0" style="width:800px;height:850px;" allowfullscreen></iframe>';this.$el.html(t)}})}),s("ev-script/views/playlist-preview",["require","ev-script/views/preview","ev-script/views/playlist-embed"],function(e){var t=e("ev-script/views/preview"),n=e("ev-script/views/playlist-embed");return t.extend({embedClass:n})}),s("ev-script/views/playlist-results",["require","jquery","ev-script/views/results","ev-script/models/playlist-settings","ev-script/views/playlist-preview"],function(e){var t=e("jquery"),n=e("ev-script/views/results"),r=e("ev-script/models/playlist-settings"),i=e("ev-script/views/playlist-preview");return n.extend({modelClass:r,previewClass:i,initialize:function(e){n.prototype.initialize.call(this,e)},getRowHtml:function(e,t){var n='  <tr class="'+(t%2?"odd":"even")+'">'+'    <td class="content-actions">'+'      <div class="action-links">'+'        <a class="action-add" href="#" title="Choose '+e.get("Name")+'" rel="'+e.get("ID")+'"><span>Choose</span></a>'+'        <a class="action-preview" href="#" title="Preview: '+e.get("Name")+'" rel="'+e.get("ID")+'"><span>Preview: '+e.get("Name")+"</span></a>"+"      </div>"+"    </td>"+'    <td class="content-meta">'+"      <span>"+e.get("Name")+"</span>"+"    </td>"+"  </tr>";return n},render:function(){var e=t('<table class="content-list"/>'),n=t("<tbody/>").appendTo(e),r="";this.collection.size()>0?this.collection.each(function(e,t){r+=this.getRowHtml(e,t)},this):r+='  <tr class="odd"><td colspan="2">No results available.</td></tr>',n.append(r),this.$results.html(e),this.$results.prepend('<div class="total">Search returned '+this.collection.totalResults+" results.</div>");if(this.collection.size()>=this.config.pageSize||e[0].scrollHeight>600)this.$scrollLoader=e.evScrollLoader({height:600,callback:this.loadMore});this.collection.bind("add",this.addHandler)}})}),s("ev-script/collections/playlists",["require","ev-script/collections/base"],function(e){var t=e("ev-script/collections/base");return t.extend({initialize:function(e,n){t.prototype.initialize.call(this,e,n),this.filterValue=n.filterValue,this.pageIndex=1,this.hasMore=!0},url:function(){var e=this.config.ensembleUrl+"/api/Playlists",t="PageSize="+this.config.pageSize,n="PageIndex="+this.pageIndex,r="FilterOn=LibraryId",i="FilterValue="+encodeURIComponent(this.filterValue),s=e+"?"+t+"&"+n+"&"+r+"&"+i;return this.config.urlCallback(s)}})}),s("ev-script/views/playlist-picker",["require","jquery","underscore","ev-script/views/picker","ev-script/views/playlist-select","ev-script/views/playlist-results","ev-script/collections/playlists"],function(e){var t=e("jquery"),n=e("underscore"),r=e("ev-script/views/picker"),i=e("ev-script/views/playlist-select"),s=e("ev-script/views/playlist-results"),o=e("ev-script/collections/playlists");return r.extend({initialize:function(e){r.prototype.initialize.call(this,e),n.bindAll(this,"loadPlaylists"),this.playlistSelect=new i({id:this.id+"-playlist-select",tagName:"div",className:"ev-playlist-select",picker:this,cache:this.cache,auth:this.auth,config:this.config}),this.$el.append(this.playlistSelect.$el),this.resultsView=new s({id:this.id+"-results",tagName:"div",className:"ev-results clearfix",picker:this,config:this.config}),this.$el.append(this.resultsView.$el)},showPicker:function(){r.prototype.showPicker.call(this),this.playlistSelect.loadOrgs(),this.playlistSelect.$("select").filter(":visible").first().focus()},loadPlaylists:function(){var e=this.model.get("libraryId"),t=this.cache.playlistsCache[this.auth.getUser()+e];t?(this.resultsView.collection=t,this.resultsView.render()):(t=new o({},{filterValue:e,config:this.config}),t.fetch({picker:this,success:n.bind(function(t,r,i){var s=t.totalResults=parseInt(r.Pager.TotalRecords,10),o=n.size(r.Data);o===s?t.hasMore=!1:(t.hasMore=!0,t.pageIndex+=1),this.cache.playlistsCache[this.auth.getUser()+e]=t,this.resultsView.collection=t,this.resultsView.render()},this),error:n.bind(function(e,t,r){this.auth.ajaxError(t,n.bind(function(){this.loadPlaylists()},this))},this)}))}})}),s("ev-script/views/playlist-settings",["require","ev-script/views/settings"],function(e){var t=e("ev-script/views/settings");return t.extend({initialize:function(e){t.prototype.initialize.call(this,e)},render:function(){var e="<h3>TODO</h3>"+JSON.stringify(this.field.model.toJSON());this.$el.html(e),this.$el.dialog({title:"Playlist Embed Settings",modal:!0,autoOpen:!1,dialogClass:"ev-dialog"})}})}),s("ev-script/views/field",["require","jquery","underscore","backbone","ev-script/models/video-settings","ev-script/models/playlist-settings","ev-script/views/video-picker","ev-script/views/video-settings","ev-script/views/video-preview","ev-script/models/video-encoding","ev-script/views/playlist-picker","ev-script/views/playlist-settings","ev-script/views/playlist-preview"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone"),i=e("ev-script/models/video-settings"),s=e("ev-script/models/playlist-settings"),o=e("ev-script/views/video-picker"),u=e("ev-script/views/video-settings"),a=e("ev-script/views/video-preview"),f=e("ev-script/models/video-encoding"),l=e("ev-script/views/playlist-picker"),c=e("ev-script/views/playlist-settings"),h=e("ev-script/views/playlist-preview");return r.View.extend({initialize:function(e){n.bindAll(this,"chooseHandler","optionsHandler","removeHandler","previewHandler"),this.$field=e.$field,this.eventAggr=e.eventAggr,this.config=e.config;var t={id:this.id+"-picker",tagName:"div",className:"ev-"+this.model.get("type")+"-picker",field:this,config:e.config,eventAggr:e.eventAggr,auth:e.auth,cache:e.cache},r={id:this.id+"-settings",tagName:"div",className:"ev-settings",field:this};this.model instanceof i?(this.modelClass=i,this.pickerClass=o,this.settingsClass=u,this.previewClass=a,this.encoding=new f({},{config:this.config}),this.model.isNew()||(this.encoding.set({fetchId:this.model.id}),this.encoding.fetch({dataType:"jsonp"})),this.model.bind("change:id",n.bind(function(){this.model.id?(this.encoding.set({fetchId:this.model.id}),this.encoding.fetch({dataType:"jsonp",success:n.bind(function(e){this.model.set({width:this.encoding.getWidth(),height:this.encoding.getHeight()})},this)})):this.encoding.clear()},this)),n.extend(r,{encoding:this.encoding})):this.model instanceof s&&(this.modelClass=s,this.pickerClass=l,this.settingsClass=c,this.previewClass=h),this.picker=new this.pickerClass(n.extend({},t,{model:new this.modelClass(this.model.toJSON())})),this.settings=new this.settingsClass(r),this.$field.after(this.picker.$el),this.renderActions(),this.model.bind("change",n.bind(function(){this.model.isNew()||(this.$field.val(JSON.stringify(this.model.toJSON())),this.renderActions())},this))},events:{"click .action-choose":"chooseHandler","click .action-preview":"previewHandler","click .action-options":"optionsHandler","click .action-remove":"removeHandler"},chooseHandler:function(e){this.eventAggr.trigger("hidePickers",this),this.picker.$el.is(":hidden")&&this.picker.showPicker(),e.preventDefault()},optionsHandler:function(e){this.settings.show(),e.preventDefault()},removeHandler:function(e){this.model.clear(),this.$field.val(""),this.model.set(this.model.defaults,{silent:!0}),this.renderActions(),e.preventDefault()},previewHandler:function(e){var t=e.currentTarget,n=new this.previewClass({el:t,encoding:this.encoding,model:this.model,config:this.config});e.preventDefault()},renderActions:function(){var e='<div class="logo"><a target="_blank" href="'+this.config.ensembleUrl+'"><span>Ensemble Logo</span></a></div>',n=this.model instanceof i?"Video":"Playlist";this.$actions||(this.$actions=t('<div class="ev-field"/>'),this.$field.after(this.$actions));if(this.model.id){var r=this.model.id,s=this.model.get("content");s&&(r=s.Name||s.Title);var o="",u=new RegExp("^"+this.config.ensembleUrl.toLocaleLowerCase()+"/app/assets/");s.ThumbnailUrl&&u.test(s.ThumbnailUrl.toLocaleLowerCase())&&(o='<div class="thumbnail">  <img alt="Video thumbnail" src="'+s.ThumbnailUrl+'"/>'+"</div>"),e+=o+'<div class="title">'+r+"</div>"+'<div class="ev-field-actions">'+'  <a href="#" class="action-choose" title="Change '+n+'"><span>Change '+n+"<span></a>"+'  <a href="#" class="action-preview" title="Preview: '+r+'"><span>Preview: '+r+"<span></a>"+(this.model instanceof i?'    <a href="#" class="action-options" title="'+n+' Embed Options"><span>'+n+" Embed Options<span></a>":"")+'  <a href="#" class="action-remove" title="Remove '+n+'"><span>Remove '+n+"<span></a>"+"</div>"}else e+='<div class="title"><em>Add '+(this.model instanceof i?"video":"playlist")+".</em></div>"+'<div class="ev-field-actions">'+'  <a href="#" class="action-choose" title="Choose '+n+'"><span>Choose '+n+"<span></a>"+"</div>";this.$actions.html(e)}})}),s("ev-script/views/auth",["require","jquery","underscore","backbone"],function(e){var t=e("jquery"),n=e("underscore"),r=e("backbone");return r.View.extend({initialize:function(e){this.eventAggr=e.eventAggr,this.config=e.config,this.auth=e.auth,this.submitCallback=e.submitCallback||function(){};var r='<div class="logo"></div><form>  <fieldset>    <div class="fieldWrap">      <label for="username">Username</label>      <input id="username" name="username" class="form-text"type="text"/>    </div>    <div class="fieldWrap">      <label for="password">Password</label>      <input id="password" name="password" class="form-text"type="password"/>    </div>    <div class="form-actions">      <input type="submit" class="form-submit action-submit" value="Submit"/>    </div>  </fieldset></form>';this.$dialog=t('<div class="ev-auth"></div>'),this.$el.after(this.$dialog),this.$dialog.dialog({title:"Ensemble Video Login - "+this.config.ensembleUrl,modal:!0,draggable:!1,resizable:!1,width:540,height:250,dialogClass:"ev-dialog",create:n.bind(function(e,t){this.$dialog.html(r)},this),close:n.bind(function(e,t){this.$dialog.dialog("destroy").remove(),this.eventAggr.trigger("hidePickers")},this)}),t("form",this.$dialog).submit(n.bind(function(e){var n=t(e.target),r=t("#username",n).val(),i=t("#password",n).val();r&&i&&(this.auth.setAuth(r,i),this.$dialog.dialog("destroy").remove(),this.submitCallback()),e.preventDefault()},this))}})}),s("ev-script",["require","backbone","underscore","jquery","ev-script/models/video-settings","ev-script/models/playlist-settings","ev-script/views/field","ev-script/views/auth","ev-script/views/video-embed","ev-script/views/playlist-embed"],function(e){var t=e("backbone"),n=e("underscore"),r=e("jquery"),i=e("ev-script/models/video-settings"),s=e("ev-script/models/playlist-settings"),o=e("ev-script/views/field"),u=e("ev-script/views/auth"),a=e("ev-script/views/video-embed"),f=e("ev-script/views/playlist-embed"),l=function(e){e=e||{};var s={authId:e.authId||"ensemble",ensembleUrl:e.ensembleUrl||"",authPath:e.authPath||"",authDomain:e.authDomain||"",urlCallback:e.urlCallback||function(e){return e},pageSize:parseInt(e.pageSize||100,10)},l={cookieOptions:{path:s.authPath},getUser:function(){return r.cookie(s.authId+"-user")},setAuth:function(e,t){e+=s.authDomain?"@"+s.authDomain:"",r.cookie(s.authId+"-user",e,n.extend({},l.cookieOptions)),r.cookie(s.authId+"-pass",t,n.extend({},l.cookieOptions)),h.trigger("authSet")},removeAuth:function(){r.cookie(s.authId+"-user",null,n.extend({},l.cookieOptions)),r.cookie(s.authId+"-pass",null,n.extend({},l.cookieOptions)),h.trigger("authRemoved")},hasAuth:function(){return r.cookie(s.authId+"-user")&&r.cookie(s.authId+"-pass")},ajaxError:function(e,t){if(e.status===401){l.removeAuth();var n=new u({el:this.el,submitCallback:t,eventAggr:h,config:s,auth:l})}else e.status===500?window.alert("It appears there is an issue with the Ensemble Video installation."):window.alert("An unexpected error occurred.  Check the server log for more details.")}},c={videosCache:[],orgsCache:[],libsCache:[],playlistsCache:[]},h=n.extend({},t.Events);this.handleField=function(e,t,n){var i=r(n,e),u=new o({id:e.id,el:e,model:t,$field:i,config:s,auth:l,cache:c,eventAggr:h})},this.handleEmbed=function(e,t){if(t instanceof i)var n=new a({el:e,model:t,config:s});else var r=new f({el:e,model:t,config:s})}};return{VideoSettings:i,PlaylistSettings:s,EnsembleApp:l}}),s("jquery",function(){return e}),s("underscore",function(){return t}),s("backbone",["jquery","underscore"],function(){return n}),i("ev-script")});